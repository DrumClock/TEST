# This file contains a configuration snippet for SWITCHING HOTEND 
#
# See docs/Config_Reference.md for a description of parameters.

#####################################################################
#  add HW config printer for dual-carriage ...
#####################################################################
# 
# [servo tool_1]      - servo for switching extruder
#

#####################################################################
# All variables in this configuration, KLIPPER merges
# into one configuration  file [gcode_macro VARIABLE] .
#
# ATTENTION:
# If the variable name already exists it will be overwritten!
#####################################################################

[gcode_macro VARIABLE]
gcode:

variable_switching_hotend: { }      # do not edit ! 

# e.g. switching_hotend = {
#                           'name': {0: 'tool_1', 1: 'tool_2'},
#                           'turn_off': {0: False, 1: False},
#                           'extruder3': {'delay': 200, 'index': 1, 'angle': 135, 'off': False},
#                           'extruder1': {'delay': 200, 'index': 0, 'angle': 135, 'off': False},
#                           'extruder2': {'delay': 200, 'index': 1, 'angle': 45, 'off': False},
#                           'extruder':  {'delay': 200, 'index': 0, 'angle': 45, 'off': False}
#                        }

#############################################################
# Creating a list of variables from the printer configuration
# using [gcode_macro RUN_MACRO_INIT] which will run
# in [delayed_gcode _INIT] after restarting FW Klipper.
#
# This macro finds all defined _INIT_* macros and runs them.
# The start order can be defined by names: _A_INIT_* , _B_INIT_* etc.
#############################################################

[gcode_macro _G_INIT_SWITCHING_HOTEND]          
gcode:

   {% set user_vars = printer["gcode_macro VARIABLE"] %} 
   {% set switching_hotend = { 'enable': false }  %} 

   {% if user_vars.servo.index is defined %}   

   ### update switching_hotend variable by configuration of printer     

    ### update  { 'name' and 'turn_off' }
    {% set ns = namespace(index=0|int) %}
    {% set _dummy = switching_hotend.update( { 'name': { } }) %}
    {% set _dummy = switching_hotend.update( { 'turn_off': { } }) %}

    {% for object in printer.configfile.config|sort %}        
       {% if 'servo ' is in object  %}             
          {% if object.split(' ')[0] == 'servo' %} 
            {% set _dummy = switching_hotend.name.update( { ns.index : (object.split(' ')[1])} ) %}
            {% set _dummy = switching_hotend.turn_off.update( { ns.index : False } ) %}
            {% set ns.index =  ns.index + 1 %}  
          {% endif %}
       {% endif %} 
     {% endfor %}  
     
     ### update { 'extruder' } by configuration of toolhead variable   
    {% for index in user_vars.toolhead|sort %}  
      {% for tool in user_vars.toolhead[index] %}
       {% set angle = 45 if loop.index0 == 0 else 135 %}  
        {% set _dummy = switching_hotend.update( {'enable':True, tool: {'index': index ,'angle': angle|int,  'delay' :200 , 'off':  False }} ) %}       
       {% endfor %}
    {% endfor %}
  
    {action_respond_info("Creating a list of variables switching_hotend" )}    

 {% endif %}

   ### update variables  
   SET_GCODE_VARIABLE MACRO=VARIABLE   VARIABLE=switching_hotend     VALUE="{switching_hotend}"
  
#####################################################################
# PRINTER SWITCHING SERVO MANAGEMENT
# Function description: switching servo for define extruder (nozzle).
#####################################################################
[gcode_macro SWITCHING_HOTEND]
description: Set : SWITCHING_HOTEND  E=(name)
gcode:
     ### params.E = [extruder|extruder1|extruder2|extruder3]
     
    {% set user_vars = printer["gcode_macro VARIABLE"] %}
    {% set tool_name = params.E %} 

#    {% if user_vars.switching_hotend.enable %}

         {% set index = user_vars.switching_hotend[tool_name].index %} 
         {% set name =  user_vars.switching_hotend.name[index] %} 
         {% set angle = user_vars.switching_hotend[tool_name].angle %}
         {% set delay =user_vars.switching_hotend[tool_name].delay %}
         
            SET_SERVO SERVO={name} angle={angle}
             G4 P{delay} 

          ### update info "angle" variable.servo  for M280
         {% if printer['gcode_macro M280'] is defined %}  
           {% set var_servo = user_vars.servo %}
           {% set _dummy = var_servo.angle.update( { index|int : angle } ) %} 
           SET_GCODE_VARIABLE MACRO=VARIABLE  VARIABLE=servo VALUE="{var_servo}"
         {% endif %}  
 
           ### turn off the servos after 15 seconds   
         {% if user_vars.switching_hotend[tool_name].off  %}            
            ### update info "turn_off" variable       
             {% set servo = user_vars.switching_hotend %} 
             {% set _dummy =servo.turn_off.update( {index|int: True}  ) %}
               SET_GCODE_VARIABLE MACRO=VARIABLE  VARIABLE=switching_hotend  VALUE="{servo}"             
               UPDATE_DELAYED_GCODE ID=SERVO_OFF  DURATION=15              
           {% endif %}   

         ### if the extruder is not activated
         {% if printer.toolhead.extruder != tool_name %}       
            ACTIVATE_EXTRUDER EXTRUDER={tool_name}
            # SET_GCODE_VARIABLE MACRO=VARIABLE VARIABLE=active_tool VALUE={tool_nr}
         {% endif %}
#    {% else %}
#       RESPOND MSG=" SWITCHING HOTEND is disabled !"
#    {% endif %}

 

#####################################################################
####   TURN SERVO_OFF  - delayed_gcode 
#####################################################################

[delayed_gcode SERVO_OFF]
initial_duration: 0.0
gcode:
   
   {% set user_vars = printer["gcode_macro VARIABLE"] %}
      
     ### switching servo OFF   
   {% for count in range(0, user_vars.switching_hotend.turn_off|length)  %}  
      {% if  user_vars.switching_hotend.turn_off[count] %}
          {% set servo_name =  user_vars.switching_hotend.name[count] %}   
             SET_SERVO SERVO={servo_name}   WIDTH=0    
           {action_respond_info("Switching servo %s turn off" % (servo_name))}    
          
          ### update info "turn_off" variable       
             {% set servo = user_vars.switching_hotend %} 
             {% set _dummy =servo.turn_off.update( {count|int: False}  ) %}
               SET_GCODE_VARIABLE MACRO=VARIABLE  VARIABLE=switching_hotend  VALUE="{servo}"          
        {% endif %}                   
   {% endfor %}

 
 