# This file contains a configuration snippet for  DUAL-EXTRUDER PRINT modes.
#

#####################################################################
#  Variable for this configurations
#  ATTENTION: 
#  KLIPPER merges all [gcode_macro VARIABLE] into one configuration file.
#  If the variable name already exists it will be overwritten!
#####################################################################

[gcode_macro VARIABLE]
gcode:

variable_extruder_mode: { }     

# e.g. extruder_mode =  { 'active': 1 , 'retract':1,  'extrude':2  }          

#############################################################
# Creating a list of variables from the printer configuration
# using [gcode_macro RUN_MACRO_INIT] which will run
# in [delayed_gcode _INIT] after restarting FW Klipper.
#
# This macro finds all defined _INIT_* macros and runs them.
# The start order can be defined by names: _A_INIT_* , _B_INIT_* etc.
#############################################################

[gcode_macro _INIT_SET_DUAL_EXTRUDER]  
gcode:

    {% set user_vars = printer["gcode_macro VARIABLE"] %} 

    ### init defautl variable
      {% set name = "extruder_mode" %}    # name variable
       {% set init = { } %}     # default preset   
       
       {% set _dummy = init.update( {'active': 1 , 'retract':1,  'extrude':2  })%}
       
       ### save variable 
   SET_GCODE_VARIABLE MACRO=VARIABLE VARIABLE={name} VALUE="{init}"  
   
  {action_respond_info("Creating a list of variables for extruder mode.")}

  
#####################################################################
# DUAL-EXTRUDER PRINT MODES  - MANAGEMENT
# Function description: 
#####################################################################
#
# SET_DUAL_EXTRUDER: Set dual-extruder print mode  
#
# Parameters:
# M [mode]  
# T [toolhead]  
#
# Mode:
# S1 - Dual-extruder mode (default mode)
# S2 - Revers-extruder mode
# S3 - Single-extruder mode [T]
# S4 - Endless spool mode
# S5 - Regeneration wipe tower mode 
#
# Example:
# SET_DUAL_EXTRUDER M=<mode> T=<tool> 
#
##############################################

[gcode_macro SET_DUAL_EXTRUDER]  
description: Set dual-extruder print mode: SET_DUAL_EXTRUDER   M=<mode> T=<tool> 
gcode:

# tool = {0:'extruder', 1:'extruder1'}   
# extruder_mode = {'active':1, 'retract':1, 'extrude':2  }
 
   ### params.M=[1|2|3|4|5]

   {% set user_vars = printer["gcode_macro VARIABLE"] %}
   {% set mode = params.M|default(1)|int %}     
   {% set init_tool =  user_vars.tool      %}
   {% set init_mode = user_vars.extruder_mode    %}
  
  ### safety tests  
  {% if printer.dual_carriage is defined  and  user_vars.idex_mode.active  != 1 %}
      ### ignore all extruder modes
      {action_respond_info("SET_DUAL_EXTRUDER are available only for dual-carriage mode M605 S1.")}
      {action_respond_info("First set dual-carriage mode M605 S1  !!" )}  
  {% else %}     
     
    ### Dual-extruder mode (default mode S1) 
    {% if (mode) == 1 %}
       {% set _dummy =init_tool.update(  { 0:'extruder', 1:'extruder1'} )  %}
       {% set _dummy =  init_mode.update( { 'active': 1 } ) %}
       #{action_respond_info("Dual-extruder mode is active")}     

    ### Reverse-extruder mode S2 - (T0>>T1 and T1>>T0)
    {% elif (mode) == 2 %}
       {% set _dummy =init_tool.update(  {0: 'extruder1',  1:'extruder' } )  %}
       {% set _dummy =  init_mode.update( { 'active': 2 } ) %}        
       #{action_respond_info("Reverse-extruder mode is active")}
        
    ### Single-extruder mode S3 define T0 or T1 
    {% elif (mode) == 3 %}      
       {% set one_tool = params.T|default(0)|int %}
       {% set tool_name =  'extruder' if one_tool ==0  else 'extruder1' %}  
       {% set _dummy =init_tool.update( { 0: tool_name , 1: tool_name} )  %}  
       {% set _dummy =  init_mode.update( { 'active': 3 } ) %}
       
       {% if "z" in printer.toolhead.homed_axes %}
           T{one_tool} 
       {% endif %}
       #  {action_respond_info("Single-extruder mode is active for tool: T%s" % one_tool)} 

# {% elif (mode) == 4 %}
  
# {% elif (mode) == 5 %}    

     {% else %}        
           {action_respond_info("Params M=%s is not defined for SET_DUAL_EXTRUDER macro!" %  mode)} 
     {% endif %}   ### (mode)  
    
      ### update variable 'tool'   
      SET_GCODE_VARIABLE MACRO=VARIABLE VARIABLE=tool  VALUE="{init_tool}"
      
       ### update variable 'extruder_mode'
      SET_GCODE_VARIABLE MACRO=VARIABLE VARIABLE=extruder_mode  VALUE="{init_mode}" 

      ### get info g-code redirect to extruder
       {% set act_mode = {1:'Dual-extruder', 2:'Reverse-extruder', 3:'Single-extruder', 4:'Endless spool', 5:'Regeneration wipe tower '} [init_mode.active]  %}
       {action_respond_info("G-code T1 is redirected to %s" % init_tool.1)}
       {action_respond_info("G-code T0 is redirected to %s" % init_tool.0)} 
       {action_respond_info("Active mod: : %s" % act_mode)} 

 {% endif %}   ### safety tests  
 
 