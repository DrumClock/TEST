# HW configuration
#
# for servo index 0
# [output_pin led_lower_0]   
# [output_pin led_upper_0]   
#
# for servo index 1
# [output_pin led_lower_1]   
# [output_pin led_upper_1]   
#
#
#  macro use variable:
#  user_vars.servo = {'index': {0: 'tool_1', 1: 'tool_2'}
#
#  --------------------------------------------------------------------
#
# Each servo has two LEDs:
#
# led_lower - lights up when the angle is 0-89
# led_upper - lights up when the angle is 91-180
#
# When the servo angle is 90 - both LEDs light up
#
#  --------------------------------------------------------------------
 
[gcode_macro LED_SERVO]
gcode:
   
  {% set user_vars = printer["gcode_macro VARIABLE"] %}
                  
   {% for servo_nr in user_vars.servo.index %}
      {% set servo_index = ("servo %s") % ( user_vars.servo.index[servo_nr|int] ) %}
      {% set led_lower = 0 %} 
      {% set led_upper = 0 %} 
          
      {% if printer[servo_index].value != 0.0 %}     
        {% set cfg = printer.configfile.settings[servo_index|lower] %}
        {% set calc_angle = (printer[servo_index].value * 0.020 - cfg.minimum_pulse_width) / 
            ((cfg.maximum_pulse_width - cfg.minimum_pulse_width) / cfg.maximum_servo_angle) %}
     
         {% set led_lower = 1  if  calc_angle|int <= 90 else 0 %}        # led lower position servo
         {% set led_upper = 1  if  calc_angle|int >= 90 else 0 %}        # led upper position servo
              
       {% endif %}

     SET_PIN PIN={'led_lower_'+servo_nr|string}    VALUE={led_lower }      
     SET_PIN PIN={'led_upper_'+servo_nr|string}    VALUE={led_upper }        
             
   {% endfor %}
     
  
